# Puppet CI Resources
classes:
  - nsidc_jenkins
  - nsidc_nfs

# NFS Mounts
nsidc_nfs::sharemounts:
  /share/sw/packages:
    project: sw
    share: packages

# Jenkins Plugins
nsidc_jenkins::plugins:
  simple-theme-plugin: {}

search-solr-tools-name: search-solr-tools
search_solr_tools_repo: git@github.com:nsidc/search-solr-tools.git
deploy_solr_tools_command: |
  rm -rf .vagrant-$ENV
  vagrant nsidc hijack --env=$ENV --project=search-solr || true

  VERSION=""
  if [ ! -z "$gem_version" ]; then
    VERSION="-v $gem_version"
  fi

  # 'gem cleanup' removes all versions of the gem but the latest
  # 'gem uninstall -x' removes the installed version and related executables
  # 'gem list' will show the installed versions to confirm that only the desired
  #    version is installed
  vagrant nsidc ssh --env=$ENV --project=search-solr -c "sudo gem cleanup search_solr_tools; sudo gem uninstall -x search_solr_tools; sudo gem install search_solr_tools $VERSION; sudo gem list --local search_solr_tools"

provision_solr_command: |
  rm -rf .vagrant-$ENV
  (vagrant nsidc hijack --env=$ENV || true)
  (vagrant nsidc destroy --env=$ENV || true)
  vagrant nsidc up --env=$ENV
  bundle exec rake jenkins:release:tag_deployment[$ENV]

harvest_nsidc_command: |
  rm -rf .vagrant-$ENV
  (vagrant nsidc hijack --env=$ENV --project=search-solr || true)
  vagrant nsidc ssh --env=$ENV --project=search-solr -c "search_solr_tools harvest --data_center=nsidc --environment=$ENV"
  vagrant nsidc ssh --env=$ENV --project=search-solr -c "search_solr_tools harvest --data_center=nsidc_auto_suggest --environment=$ENV"

# Jenkins Jobs
nsidc_jenkins::jobs:
  # clone the project into the shared workspace
  "A01_%{hiera('project')}_Integration_Checkout_Project":
    workspace: /var/lib/jenkins/workspaces/%{hiera('project')}/integration
    parameters:
      - type: string
        name: ref
        description: git ref (branch, tag, or SHA) to checkout
        default: master
    git:
      repo: "%{hiera('gitrepo')}"
      poll_scm: true
      checkout_local: false
    command: |
      git checkout $ref
    trigger_job: "A02_%{hiera('project')}_Integration_Install_Dependencies"

  "A02_%{hiera('project')}_Integration_Install_Dependencies":
    workspace: /var/lib/jenkins/workspaces/%{hiera('project')}/integration
    command: bundle install
    trigger_job: "A03_%{hiera('project')}_Integration_Provision"

  "A03_%{hiera('project')}_Integration_Provision":
    command: |
      ENV=integration
      %{hiera('provision_solr_command')}
    workspace: /var/lib/jenkins/workspaces/%{hiera('project')}/integration
    trigger_job: "A04_%{hiera('search-solr-tools-name')}_Deploy_solr-search-tools-gem"

  "A04_%{hiera('search-solr-tools-name')}_Deploy_solr-search-tools-gem":
    workspace: /var/lib/jenkins/workspaces/%{hiera('search-solr-tools-name')}/integration
    parameters:
      - type: string
        name: gem_version
        description: >-
          The version of search_solr_tools to install; if none is given, the
          latest (non-prerelease) release will be installed.
        default: ""
    command: |
      ENV=integration
      %{hiera('deploy_solr_tools_command')}
    trigger_job: "A05_%{hiera('search-solr-tools-name')}_Integration_Harvest_NSIDC"

  "A05_%{hiera('search-solr-tools-name')}_Integration_Harvest_NSIDC":
    command: |
      ENV=integration
      %{hiera('harvest_nsidc_command')}
    workspace: /var/lib/jenkins/workspaces/%{hiera('search-solr-tools-name')}/integration
    trigger_job: "A06_%{hiera('search-solr-tools-name')}_Integration_Harvest_ADE"

  "A06_%{hiera('search-solr-tools-name')}_Integration_Harvest_ADE":
    description: Sequentially harvest all of the ADE metadata sources.
    workspace: /var/lib/jenkins/workspaces/%{hiera('search-solr-tools-name')}/integration
    triggers:
      - jobs:
          - "%{hiera('search-solr-tools-name')}_Harvest_ADE_adc"
        parameters:
          environment: integration
          predefined_parameters: true
        threshold: FAILURE

  "%{hiera('search-solr-tools-name')}_Harvest_ADE_adc":
    parameters:
      - type: string
        name: environment
        description: The deployment environment to update.
        default: integration
    command: |
      ENV=${environment}
      vagrant nsidc ssh --env=$ENV --project=search-solr -c "search_solr_tools harvest --data-center=adc  --environment=$ENV"
    triggers:
      - jobs:
          - "%{hiera('search-solr-tools-name')}_Harvest_ADE_bco_dmo"
        parameters:
          current_build_paramters: true
          predefined_parameters: true
        threshold: FAILURE

  "%{hiera('search-solr-tools-name')}_Harvest_ADE_bco_dmo":
    parameters:
      - type: string
        name: environment
        description: The deployment environment to update.
        default: integration
    command: |
      ENV=${environment}
      set +e
      vagrant nsidc ssh --env=$ENV --project=search-solr -c "search_solr_tools harvest --data-center=bco_dmo  --environment=$ENV"
      true
    triggers:
      - jobs:
          - "%{hiera('search-solr-tools-name')}_Harvest_ADE_echo"
        parameters:
          current_build_paramters: true
          predefined_parameters: true
        threshold: FAILURE

  "%{hiera('search-solr-tools-name')}_Harvest_ADE_echo":
    parameters:
      - type: string
        name: environment
        description: The deployment environment to update.
        default: integration
    command: |
      ENV=${environment}
      vagrant nsidc ssh --env=$ENV --project=search-solr -c "search_solr_tools harvest --data-center=echo  --environment=$ENV"
    workspace: /var/lib/jenkins/workspaces/%{hiera('search-solr-tools-name')}/integration
    trigger_threshold: FAILURE
    triggers:
      - jobs:
          - "%{hiera('search-solr-tools-name')}_Harvest_ADE_ices"
        parameters:
          current_build_paramters: true
          predefined_parameters: true
        threshold: FAILURE

  "%{hiera('search-solr-tools-name')}_Harvest_ADE_ices":
    parameters:
      - type: string
        name: environment
        description: The deployment environment to update.
        default: integration
    command: |
      ENV=${environment}
      vagrant nsidc ssh --env=$ENV --project=search-solr -c "search_solr_tools harvest --data-center=ices  --environment=$ENV"
    triggers:
      - jobs:
          - "%{hiera('search-solr-tools-name')}_Harvest_ADE_nmi"
        parameters:
          current_build_paramters: true
          predefined_parameters: true
        threshold: FAILURE

  "%{hiera('search-solr-tools-name')}_Harvest_ADE_nmi":
    parameters:
      - type: string
        name: environment
        description: The deployment environment to update.
        default: integration
    command: |
      ENV=${environment}
      vagrant nsidc ssh --env=$ENV --project=search-solr -c "search_solr_tools harvest --data-center=nmi  --environment=$ENV"
    triggers:
      - jobs:
          - "%{hiera('search-solr-tools-name')}_Harvest_ADE_nodc"
        parameters:
          current_build_paramters: true
          predefined_parameters: true
        threshold: FAILURE

  "%{hiera('search-solr-tools-name')}_Harvest_ADE_nodc":
    parameters:
      - type: string
        name: environment
        description: The deployment environment to update.
        default: integration
    command: |
      ENV=${environment}
      vagrant nsidc ssh --env=$ENV --project=search-solr -c "search_solr_tools harvest --data-center=nodc  --environment=$ENV"
    triggers:
      - jobs:
          - "%{hiera('search-solr-tools-name')}_Harvest_ADE_pdc"
        parameters:
          current_build_paramters: true
          predefined_parameters: true
        threshold: FAILURE

  "%{hiera('search-solr-tools-name')}_Harvest_ADE_pdc":
    parameters:
      - type: string
        name: environment
        description: The deployment environment to update.
        default: integration
    command: |
      ENV=${environment}
      vagrant nsidc ssh --env=$ENV --project=search-solr -c "search_solr_tools harvest --data-center=pdc  --environment=$ENV"
    triggers:
      - jobs:
          - "%{hiera('search-solr-tools-name')}_Harvest_ADE_r2r"
        parameters:
          current_build_paramters: true
          predefined_parameters: true
        threshold: FAILURE

  "%{hiera('search-solr-tools-name')}_Harvest_ADE_r2r":
    parameters:
      - type: string
        name: environment
        description: The deployment environment to update.
        default: integration
    command: |
      ENV=${environment}
      vagrant nsidc ssh --env=$ENV --project=search-solr -c "search_solr_tools harvest --data-center=r2r  --environment=$ENV"
    triggers:
      - jobs:
          - "%{hiera('search-solr-tools-name')}_Harvest_ADE_rda"
        parameters:
          current_build_paramters: true
          predefined_parameters: true
        threshold: FAILURE

  "%{hiera('search-solr-tools-name')}_Harvest_ADE_rda":
    parameters:
      - type: string
        name: environment
        description: The deployment environment to update.
        default: integration
    command: |
      ENV=${environment}
      vagrant nsidc ssh --env=$ENV --project=search-solr -c "search_solr_tools harvest --data-center=rda  --environment=$ENV"
    triggers:
      - jobs:
          - "%{hiera('search-solr-tools-name')}_Harvest_ADE_tdar"
        parameters:
          current_build_paramters: true
          predefined_parameters: true
        threshold: FAILURE

  "%{hiera('search-solr-tools-name')}_Harvest_ADE_tdar":
    parameters:
      - type: string
        name: environment
        description: The deployment environment to update.
        default: integration
    command: |
      ENV=${environment}
      vagrant nsidc ssh --env=$ENV --project=search-solr -c "search_solr_tools harvest --data-center=tdar  --environment=$ENV"
    triggers:
      - jobs:
          - "%{hiera('search-solr-tools-name')}_Harvest_ADE_usgs"
        parameters:
          current_build_paramters: true
          predefined_parameters: true
        threshold: FAILURE

  "%{hiera('search-solr-tools-name')}_Harvest_ADE_usgs":
    parameters:
      - type: string
        name: environment
        description: The deployment environment to update.
        default: integration
    command: |
      ENV=${environment}
      vagrant nsidc ssh --env=$ENV --project=search-solr -c "search_solr_tools harvest --data-center=usgs  --environment=$ENV"
    triggers:
      - jobs:
          - "%{hiera('search-solr-tools-name')}_Harvest_ADE_zzz_ade_auto_suggest"
        parameters:
          current_build_paramters: true
          predefined_parameters: true
        threshold: FAILURE

  "%{hiera('search-solr-tools-name')}_Harvest_ADE_zzz_ade_auto_suggest":
    parameters:
      - type: string
        name: environment
        description: The deployment environment to update.
        default: integration
    command: |
      ENV=${environment}
      vagrant nsidc ssh --env=$ENV --project=search-solr -c "search_solr_tools harvest --data-center=ade_auto_suggest  --environment=$ENV"
    triggers:
      - jobs:
          - "A07_%{hiera('project')}_${environment}_acceptance_tests"
        parameters:
          current_build_paramters: true
          predefined_parameters: true
        threshold: FAILURE

  "A07_%{hiera('project')}_integration_acceptance_tests":
    command: |
      ENV=integration
      rm -rf .vagrant-$ENV
      (vagrant nsidc hijack --env=$ENV --project=search-solr || true)
      vagrant nsidc ssh --env=$ENV --project=search-solr -c 'cd /opt/search-solr; bundle install --path=.gem; bundle exec rake spec:acceptance'
    workspace: /var/lib/jenkins/workspaces/search-solr/integration

  "B01_%{hiera('project')}_QA_Checkout_Project":
    git:
      repo: "%{hiera('gitrepo')}"
      wipe_workspace: true
    parameters:
      - type: string
        name: ref
        description: git ref (branch, tag, or SHA) to checkout
        default: master
    command: |
      git checkout $ref
    workspace: /var/lib/jenkins/workspaces/%{hiera('project')}/qa
    trigger_job: "B02_%{hiera('project')}_QA_Install_Dependencies"

  "B02_%{hiera('project')}_QA_Install_Dependencies":
    command: bundle install
    workspace: /var/lib/jenkins/workspaces/%{hiera('project')}/qa
    trigger_job: "B03_%{hiera('project')}_QA_Provision"

  "B03_%{hiera('project')}_QA_Provision":
    command: |
      ENV=qa
      %{hiera('provision_solr_command')}
    workspace: /var/lib/jenkins/workspaces/%{hiera('project')}/qa
    trigger_job: "B04_%{hiera('search-solr-tools-name')}_Deploy_solr-search-tools-gem"

  "B04_%{hiera('search-solr-tools-name')}_Deploy_solr-search-tools-gem":
    workspace: /var/lib/jenkins/workspaces/%{hiera('search-solr-tools-name')}/qa
    parameters:
      - type: string
        name: gem_version
        description: >-
          The version of search_solr_tools to install; if none is given, the
          latest (non-prerelease) release will be installed.
        default: ""
    command: |
      ENV=qa
      %{hiera('deploy_solr_tools_command')}
    trigger_job: "B05_%{hiera('search-solr-tools-name')}_QA_Harvest_NSIDC"

  "B05_%{hiera('search-solr-tools-name')}_QA_Harvest_NSIDC":
    command: |
      ENV=qa
      %{hiera('harvest_nsidc_command')}
    workspace: /var/lib/jenkins/workspaces/%{hiera('search-solr-tools-name')}/qa
    trigger_job: "B06_%{hiera('search-solr-tools-name')}_QA_Harvest_ADE"

  "B06_%{hiera('search-solr-tools-name')}_QA_Harvest_ADE":
    workspace: /var/lib/jenkins/workspaces/%{hiera('search-solr-tools-name')}/qa
    triggers:
      - jobs:
          - "%{hiera('search-solr-tools-name')}_Harvest_ADE_adc"
        parameters:
          environment: qa
          predefined_parameters: true
        threshold: FAILURE

  "B07_%{hiera('project')}_qa_acceptance_tests":
    command: |
      ENV=qa
      rm -rf .vagrant-$ENV
      (vagrant nsidc hijack --env=$ENV --project=search-solr || true)
      vagrant nsidc ssh --env=$ENV --project=search-solr -c 'cd /opt/search-solr; bundle install --path=.gem; bundle exec rake spec:acceptance'
    workspace: /var/lib/jenkins/workspaces/search-solr/qa

  "C01_%{hiera('project')}_Staging_Checkout_Project":
    git:
      repo: "%{hiera('gitrepo')}"
      wipe_workspace: true
    parameters:
      - type: string
        name: ref
        description: git ref (branch, tag, or SHA) to checkout
        default: qa
    command: |
      git checkout $ref
    workspace: /var/lib/jenkins/workspaces/%{hiera('project')}/staging
    trigger_job: "C02_%{hiera('project')}_Staging_Install_Dependencies"

  "C02_%{hiera('project')}_Staging_Install_Dependencies":
    command: bundle install
    workspace: /var/lib/jenkins/workspaces/%{hiera('project')}/staging
    trigger_job: "C03_%{hiera('project')}_Staging_Provision"

  "C03_%{hiera('project')}_Staging_Provision":
    command: |
      ENV=staging
      %{hiera('provision_solr_command')}
    workspace: /var/lib/jenkins/workspaces/%{hiera('project')}/staging
    trigger_job: "C04_%{hiera('search-solr-tools-name')}_Deploy_solr-search-tools-gem"

  "C04_%{hiera('search-solr-tools-name')}_Deploy_solr-search-tools-gem":
    workspace: /var/lib/jenkins/workspaces/%{hiera('search-solr-tools-name')}/staging
    parameters:
      - type: string
        name: gem_version
        description: >-
          The version of search_solr_tools to install; if none is given, the
          latest (non-prerelease) release will be installed.
        default: ""
    command: |
      ENV=staging
      %{hiera('deploy_solr_tools_command')}
    trigger_job: "C05_%{hiera('search-solr-tools-name')}_Staging_Harvest_NSIDC"

  "C05_%{hiera('search-solr-tools-name')}_Staging_Harvest_NSIDC":
    command: |
      ENV=staging
      %{hiera('harvest_nsidc_command')}
    workspace: /var/lib/jenkins/workspaces/%{hiera('search-solr-tools-name')}/staging
    trigger_job: "C06_%{hiera('search-solr-tools-name')}_Staging_Harvest_ADE"

  "C06_%{hiera('search-solr-tools-name')}_Staging_Harvest_ADE":
    workspace: /var/lib/jenkins/workspaces/%{hiera('search-solr-tools-name')}/staging
    triggers:
      - jobs:
          - "%{hiera('search-solr-tools-name')}_Harvest_ADE_adc"
        parameters:
          environment: staging
          predefined_parameters: true
        threshold: FAILURE

  "C07_%{hiera('project')}_staging_acceptance_tests":
    command: |
      ENV=staging
      rm -rf .vagrant-$ENV
      (vagrant nsidc hijack --env=$ENV --project=search-solr || true)
      vagrant nsidc ssh --env=$ENV --project=search-solr -c 'cd /opt/search-solr; bundle install --path=.gem; bundle exec rake spec:acceptance'
    workspace: /var/lib/jenkins/workspaces/search-solr/staging
    trigger_job: "D01_%{hiera('search-solr-tools-name')}_Blue_Checkout_Project"

  "D01_%{hiera('project')}_Blue_Provision":
    git:
      repo: "%{hiera('gitrepo')}"
      wipe_workspace: true
    parameters:
      - type: string
        name: ref
        description: git ref (branch, tag, or SHA) to checkout
        default: staging
    command: |
      ENV=blue
      git checkout $ref
      bundle install
      %{hiera('provision_solr_command')}
    workspace: /var/lib/jenkins/workspaces/%{hiera('project')}/blue
    trigger_job: "D02_%{hiera('search-solr-tools-name')}_Deploy_solr-search-tools-gem"

  "D02_%{hiera('search-solr-tools-name')}_Deploy_solr-search-tools-gem":
    workspace: /var/lib/jenkins/workspaces/%{hiera('search-solr-tools-name')}/blue
    parameters:
      - type: string
        name: gem_version
        description: >-
          The version of search_solr_tools to install; if none is given, the
          latest (non-prerelease) release will be installed.
        default: ""
    command: |
      ENV=blue
      %{hiera('deploy_solr_tools_command')}
    trigger_job: "D03_%{hiera('search-solr-tools-name')}_Blue_Harvest_NSIDC"

  "D03_%{hiera('search-solr-tools-name')}_Blue_Harvest_NSIDC":
    command: |
      ENV=blue
      %{hiera('harvest_nsidc_command')}
    workspace: /var/lib/jenkins/workspaces/%{hiera('search-solr-tools-name')}/blue
    trigger_job: "D04_%{hiera('search-solr-tools-name')}_Blue_Harvest_ADE"

  "D04_%{hiera('search-solr-tools-name')}_Blue_Harvest_ADE":
    workspace: /var/lib/jenkins/workspaces/%{hiera('search-solr-tools-name')}/blue
    triggers:
      - jobs:
          - "%{hiera('search-solr-tools-name')}_Harvest_ADE_adc"
        parameters:
          environment: blue
          predefined_parameters: true
        threshold: FAILURE

  "E01_%{hiera('project')}_Release_Bump_Version":
    git:
      repo: "%{hiera('gitrepo')}"
      wipe_workspace: true
    parameters:
      - type: string
        name: branch
        description: git branch to checkout and tag
        default: master
      - type: choice
        name: version_part
        choices:
        - patch
        - minor
        - major
    command: |
      git checkout $branch

      bundle install
      bundle exec rake jenkins:release:bump[$version_part]
    workspace: /var/lib/jenkins/workspaces/%{hiera('project')}/release
    trigger_job: "E02_%{hiera('project')}_Release_Push_to_Git"

  "E02_%{hiera('project')}_Release_Push_to_Git":
    command: bundle exec rake jenkins:release:push
    workspace: /var/lib/jenkins/workspaces/%{hiera('project')}/release
